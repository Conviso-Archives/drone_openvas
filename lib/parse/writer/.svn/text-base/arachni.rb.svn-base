
module Parse
  module WRITER
    class Arachni
    @@file=0

     def initialize(x)
     if File.exist?(x)
      @@file=x
      fd=File.new(x)
      doc = Document.new fd
      @@rows=doc.root
     else
      @ret= "Error in Load File!"
     end 
    end

   def write_xml(hash)
    doc = Document.new
    doc.add_element("scan")
    doc.root.add_element("header")
    header = doc.root.elements[1]
    header.add_element("tool")
    header.elements["tool"].text = hash[:toolname]
    header.add_element("project")
    header.elements["project"].text = "nome projeto cadastro checker"
    header.add_element("timestamp")
    header.elements["timestamp"].text = hash[:start_datetime]
    header.add_element("duration")
    header.elements["duration"].text = hash[:duration]
   #vulnerabilidades
    start = Element.new("vulnerabilities")
    hash[:issues].each do |x|
     vuln = doc.root.elements[1]
     vuln = Element.new("vulnerability")
     vuln.add_attribute("id", x["hash"])
     vuln.add_element("title")
     vuln.elements["title"].text=Base64.encode64(x["name"])
     vuln.add_element("description")
     vuln.elements["description"].text=Base64.encode64(x["description"])
     vuln.add_element("category")
     vuln.elements["category"].text=x["name"]
     vuln.add_element("impact")
     vuln.elements["impact"].text=x["severity"]
     vuln.add_element("exploitability")
     vuln.elements["exploitability"].text=x["severity"]
     vuln.add_element("reproduction")
     vuln.elements["reproduction"].text="#{x["cwe"]} - #{x['cwe_url']}"
     vuln.add_element("control")
     vuln.elements["control"].text="#{x['remedy_guidance']} \n #{x['remedy_code']} "  
     vuln.add_element("reference")
     vuln.elements["reference"].text=Base64.encode64(x['reference'])
   
     start << vuln
    end
 
    doc.root.insert_after("//header",start)

    File.open(@@file, "w") do |file| 
     file.puts doc
    end 
   end


    end
  end
end
